version: '3.8'

# ============================================
# Polygon L2 MVP - 单服务器部署
# 所有服务运行在一台机器上
# 适合测试和演示，不适合生产环境
# ============================================

networks:
  zkevm-network:
    driver: bridge

services:
  # ============ 数据库 (共享) ============
  
  zkevm-db:
    container_name: zkevm-db
    image: postgres:15
    restart: unless-stopped
    networks:
      - zkevm-network
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zkevmuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zkevmpassword}
      POSTGRES_DB: ${POSTGRES_DB:-zkevmdb}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zkevmuser}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ Prover (轻量级配置) ============
  
  zkevm-prover:
    container_name: zkevm-prover
    image: hermeznetwork/zkevm-prover:v4.0.0
    restart: unless-stopped
    networks:
      - zkevm-network
    volumes:
      - ./config/prover-config.json:/app/config.json
      - ./data/prover:/app/data
    ports:
      - "50061:50061"  # MT service
      - "50071:50071"  # Executor service
    environment:
      - PROVER_THREADS=${PROVER_THREADS:-4}
    command: /app/zkProver -c /app/config.json
    deploy:
      resources:
        limits:
          cpus: '8'      # MVP: 8核 (生产: 32核)
          memory: 16G    # MVP: 16GB (生产: 256GB)
        reservations:
          cpus: '4'
          memory: 8G

  # ============ Synchronizer ============
  
  zkevm-sync:
    container_name: zkevm-sync
    image: hermeznetwork/zkevm-node:v0.6.0
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
    volumes:
      - ./config/node-config.toml:/app/config.toml
      - ./config/genesis.json:/app/genesis.json
    command: run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components synchronizer
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============ Sequencer ============
  
  zkevm-sequencer:
    container_name: zkevm-sequencer
    image: hermeznetwork/zkevm-node:v0.6.0
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
      zkevm-prover:
        condition: service_started
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
    volumes:
      - ./config/node-config.toml:/app/config.toml
      - ./config/genesis.json:/app/genesis.json
      - ./config/sequencer.keystore:/pk/sequencer.keystore
    ports:
      - "8545:8545"  # RPC
      - "8546:8546"  # WebSocket
      - "9091:9091"  # Metrics
    command: run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components sequencer
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G

  # ============ Aggregator ============
  
  zkevm-aggregator:
    container_name: zkevm-aggregator
    image: hermeznetwork/zkevm-node:v0.6.0
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
      zkevm-prover:
        condition: service_started
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
    volumes:
      - ./config/node-config.toml:/app/config.toml
      - ./config/genesis.json:/app/genesis.json
      - ./config/aggregator.keystore:/pk/aggregator.keystore
    ports:
      - "50081:50081"
    command: run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components aggregator
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============ RPC Node (可选 - 如果需要公开访问) ============
  
  # zkevm-rpc:
  #   container_name: zkevm-rpc
  #   image: hermeznetwork/zkevm-node:v0.6.0
  #   restart: unless-stopped
  #   networks:
  #     - zkevm-network
  #   depends_on:
  #     zkevm-db:
  #       condition: service_healthy
  #   environment:
  #     - ZKEVM_NODE_STATEDB_HOST=zkevm-db
  #     - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
  #   volumes:
  #     - ./config/node-config.toml:/app/config.toml
  #     - ./config/genesis.json:/app/genesis.json
  #   ports:
  #     - "8123:8545"  # Public RPC
  #   command: run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components rpc
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '2'
  #         memory: 4G

# ============================================
# 资源总计 (MVP 单服务器)
# ============================================
# CPU:    18 核 (数据库2 + Prover8 + Sync2 + Sequencer4 + Aggregator2)
# 内存:   36 GB (数据库4 + Prover16 + Sync4 + Sequencer8 + Aggregator4)
# 
# 推荐服务器: 16核 64GB (有余量)
# 最低服务器: 8核 32GB (紧张但可用)
# ============================================

