# Docker Compose 配置 (移除 version 以避免警告)

# ============================================
# Polygon L2 MVP - 单服务器部署
# 所有服务运行在一台机器上
# 适合测试和演示，不适合生产环境
# ============================================

networks:
  zkevm-network:
    driver: bridge

services:
  # ============ 数据库 (共享) ============
  
  zkevm-db:
    container_name: zkevm-db
    image: postgres:15
    restart: unless-stopped
    networks:
      - zkevm-network
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-zkevmuser}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-zkevmpassword}
      POSTGRES_DB: ${POSTGRES_DB:-zkevmdb}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # 避免与 Blockscout (7432) 和本地 PostgreSQL (5432) 冲突
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-zkevmuser}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============ Prover (必需 - Sequencer 需要连接 Executor) ============
  
  zkevm-prover:
    container_name: zkevm-prover
    image: hermeznetwork/zkevm-prover:v7.0.0-fork.11
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
    volumes:
      - ./config/prover-config.json:/usr/src/app/config.json:ro
      - ./data/prover:/app/data
    ports:
      - "50061:50061"  # HashDB service
      - "50071:50071"  # Executor service
    command: /usr/local/bin/zkProver -c /usr/src/app/config.json
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

  # ============ Synchronizer ============
  
  zkevm-sync:
    container_name: zkevm-sync
    image: hermeznetwork/zkevm-node:v0.7.0-fork11
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_STATEDB_PORT=5432
      - ZKEVM_NODE_STATEDB_NAME=zkevmdb
      - ZKEVM_NODE_STATEDB_USER=zkevmuser
      - ZKEVM_NODE_STATEDB_PASSWORD=zkevmpassword
      - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
      - ZKEVM_NODE_POOL_DB_PORT=5432
      - ZKEVM_NODE_POOL_DB_NAME=pooldb
      - ZKEVM_NODE_POOL_DB_USER=zkevmuser
      - ZKEVM_NODE_POOL_DB_PASSWORD=zkevmpassword
    volumes:
      - ./config/node-config.toml:/app/config.toml:ro
      - ./config/genesis.json:/app/genesis.json:ro
    command: 
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components synchronizer"
    deploy:
      resources:
        limits:
          cpus: '0.5'    # 降低到0.5核
          memory: 2G

  # ============ Sequencer ============
  
  zkevm-sequencer:
    container_name: zkevm-sequencer
    image: hermeznetwork/zkevm-node:v0.7.0-fork11
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
      zkevm-prover:
        condition: service_started
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_STATEDB_PORT=5432
      - ZKEVM_NODE_STATEDB_NAME=zkevmdb
      - ZKEVM_NODE_STATEDB_USER=zkevmuser
      - ZKEVM_NODE_STATEDB_PASSWORD=zkevmpassword
      - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
      - ZKEVM_NODE_POOL_DB_PORT=5432
      - ZKEVM_NODE_POOL_DB_NAME=pooldb
      - ZKEVM_NODE_POOL_DB_USER=zkevmuser
      - ZKEVM_NODE_POOL_DB_PASSWORD=zkevmpassword
    volumes:
      - ./config/node-config.toml:/app/config.toml:ro
      - ./config/genesis.json:/app/genesis.json:ro
      - ./config/sequencer.keystore:/pk/sequencer.keystore:ro
    ports:
      - "8547:8545"  # RPC (避免与 L1 的 8545 冲突)
      - "8548:8546"  # WebSocket (避免与 L1 的 8546 冲突)
      - "9091:9091"  # Metrics
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components sequencer,rpc"
    deploy:
      resources:
        limits:
          cpus: '0.5'    # 降低到0.5核
          memory: 4G

  # ============ Aggregator ============
  
  zkevm-aggregator:
    container_name: zkevm-aggregator
    image: hermeznetwork/zkevm-node:v0.7.0-fork11
    restart: unless-stopped
    networks:
      - zkevm-network
    depends_on:
      zkevm-db:
        condition: service_healthy
      zkevm-prover:
        condition: service_started
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_STATEDB_PORT=5432
      - ZKEVM_NODE_STATEDB_NAME=zkevmdb
      - ZKEVM_NODE_STATEDB_USER=zkevmuser
      - ZKEVM_NODE_STATEDB_PASSWORD=zkevmpassword
    volumes:
      - ./config/node-config.toml:/app/config.toml:ro
      - ./config/genesis.json:/app/genesis.json:ro
      - ./config/aggregator.keystore:/pk/aggregator.keystore:ro
    ports:
      - "50081:50081"
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components aggregator"
    deploy:
      resources:
        limits:
          cpus: '0.5'    # 降低到0.5核
          memory: 2G

  # ============ RPC Node ============
  
  zkevm-rpc:
    container_name: zkevm-rpc
    image: hermeznetwork/zkevm-node:v0.7.0-fork11
    restart: unless-stopped
    networks:
      - zkevm-network
    extra_hosts:
      - "54.169.30.130:172.19.0.6"
    depends_on:
      zkevm-db:
        condition: service_healthy
    environment:
      - ZKEVM_NODE_STATEDB_HOST=zkevm-db
      - ZKEVM_NODE_STATEDB_PORT=5432
      - ZKEVM_NODE_STATEDB_NAME=zkevmdb
      - ZKEVM_NODE_STATEDB_USER=zkevmuser
      - ZKEVM_NODE_STATEDB_PASSWORD=zkevmpassword
      - ZKEVM_NODE_POOL_DB_HOST=zkevm-db
      - ZKEVM_NODE_POOL_DB_PORT=5432
      - ZKEVM_NODE_POOL_DB_NAME=pooldb
      - ZKEVM_NODE_POOL_DB_USER=zkevmuser
      - ZKEVM_NODE_POOL_DB_PASSWORD=zkevmpassword
    volumes:
      - ./config/node-config.toml:/app/config.toml:ro
      - ./config/genesis.json:/app/genesis.json:ro
    ports:
      - "8123:8545"  # Public RPC
    command:
      - "/bin/sh"
      - "-c"
      - "/app/zkevm-node run --network custom --custom-network-file /app/genesis.json --cfg /app/config.toml --components rpc"
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 2G

# ============================================
# 资源总计 (MVP 单服务器)
# ============================================
# CPU:    18 核 (数据库2 + Prover8 + Sync2 + Sequencer4 + Aggregator2)
# 内存:   36 GB (数据库4 + Prover16 + Sync4 + Sequencer8 + Aggregator4)
# 
# 推荐服务器: 16核 64GB (有余量)
# 最低服务器: 8核 32GB (紧张但可用)
# ============================================

